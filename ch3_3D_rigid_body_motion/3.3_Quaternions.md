# 3.3 Quaternions

Quaternions are extended complex numbers.

A quaternion q has a real part and three imaginary parts. 
$$
\mathbf{q} = q_0 + q_1 i + q_2 j + q_3 k
$$
where i, j, k are three imaginary parts of the quaternion. These three imaginary parts satisfy the following relationship:
$$
\left\{ \begin{array}{l}
{i^2} = {j^2} = {k^2} =  - 1\\
ij = k, ji = - k \\
jk = i,kj =  - i\\
ki = j, ik = - j
\end{array} \right.
$$
We can also use a scalar and a vector to express quaternions:
$$
\mathbf{q} = \left[ s, \mathbf{v} \right]^T, \quad s=q_0 \in \mathbb{R},\quad \mathbf{v} = [q_1, q_2, q_3]^T \in \mathbb{R}^3
$$
Here, $$ s $$ is the real part of the quaternion, and $$ \mathbf {v} $$ is its imaginary part. If the imaginary part of a quaternion is $$ \mathbf {0} $$, it is called *real quaternion*. Conversely, if its real part is $$ 0 $$, it is called *imaginary quaternion*.

## 3.3.1 Quaternion Operations

$$
\mathbf{q} _a = s_a + x_ai + y_aj + z_ak, \quad  \mathbf {q} _b = s_b + x_bi + y_bj + z_bk
$$

1. Addition and subtraction
   $$
   \mathbf{q}_a \pm \mathbf{q}_b = \left[ s_a \pm s_b, \mathbf{v}_a \pm \mathbf{v}_b \right]^T
   $$
   
2. Multiplication
   $$
   \mathbf{q}_a \mathbf{q}_b = \left[ s_a s_b - \mathbf{v}_a^T \mathbf{v}_b, s_a\mathbf{v}_b + s_b\mathbf{v}_a + \mathbf{v}_a \times \mathbf{v}_b \right]^T
   $$
   
3. Length
   $$
       \| \mathbf{q}_a \| = \sqrt{ s_a^2 + x_a^2 + y_a^2 + z_a^2 }.
   $$
   It can be verified that the length of the product is the product of the lengths. This makes the unit quaternion keep unit-length when multiplied by another unit quaternion:
   $$
       \| \mathbf{q}_a \mathbf{q}_b \| = \|\mathbf{q}_a \| \| \mathbf{q}_b \|.
   $$
   
4. Conjugate

   The conjugate of a quaternion is to take the imaginary part as the opposite:
   $$
       \mathbf{q}_a ^ * = s_a - x_ai - y_aj - z_ak = [s_a, - \mathbf{v}_a] ^T.
   $$
    We get a real quaternion if the quaternion is multiplied by its conjugate. The real part is the square of its length:
   $$
   \mathbf{q}^* \mathbf{q} = \mathbf{q} \mathbf{q}^* = [s^2+\mathbf{v}^T \mathbf{v}, \mathbf{0} ]^T
   $$
   
5. Inverse
   $$
       \mathbf{q} ^ { - 1 } = \mathbf{q} ^ * / \| \mathbf{q} \| ^ 2.
   $$
   According to this definition, the product of the quaternion and its inverse is the real quaternion $$ \mathbf {1} $$:
   $$
       \mathbf{q} \mathbf{q}^{-1} = \mathbf{q}^{-1} \mathbf{q} = \mathbf{1}.
   $$
   If $$ \mathbf{q} $$ is a unit quaternion, its inverse and conjugate are the same. So the inverse of the product has properties similar to matrices:
   $$
   \left( \mathbf{q}_a \mathbf{q}_b \right)^{-1} = \mathbf{q}_b^{-1} \mathbf{q}_a^{-1}.
   $$
   
6. Scalar Multiplication

$$
    k \mathbf{q} = \left[ ks, k\mathbf{v} \right]^T.
$$

## 3.3.2 Use Quaternion to Represent a Rotation

Suppose a spatial 3D point $$ \mathbf{p} = [x,y,z]^T \in  \mathbb {R}^3 $$, and a rotation is specified by a unit quaternion $$ \mathbf{q}$$.

1. Extend the 3D point to an imaginary quaternion:
   $$
   \mathbf{p} = [0, x, y, z]^T = [0, \mathbf{v}]^T. 
   $$
   
2. The rotated point $$p'$$ can be expressed as such a product:
   $$
   \mathbf{p}' = \mathbf{q} \mathbf{p} \mathbf{q}^{-1}.
   $$

## 3.3.3 Conversion of Quaternions to Other Rotation Representations

The relationship between quaternions and rotation vectors / matrices.

Let $$ \mathbf{q}=[s,\mathbf{v}]^T $$, then define the following symbols $$^{+}$$ and $$^{\oplus}$$
$$
\mathbf{q}^{+}=\left[\begin{array}{cc}
		s&-\mathbf{v}^T \\
		\mathbf{v}&s\mathbf{I}+\mathbf{v}^{\wedge}
	\end{array}\right],\quad
	\mathbf{q}^{\oplus}=
	\left[\begin{array}{cc}
		s & -\mathbf{v}^T \\
		\mathbf{v} & s\mathbf{I}-\mathbf{v}^{\wedge}
	\end{array}\right]
$$
These two symbols map the quaternion to a 4x4 matrix.
$$
\mathbf{q}_1^ + {\mathbf{q}_2} = \left[ {\begin{array}{*{20}{c}}
			s_1&-\mathbf{v}_1^T\\
			\mathbf{v}_1 & s_1 \mathbf{I} + \mathbf{v}_1^\wedge
	\end{array}} \right]\left[ {\begin{array}{*{20}{c}}
			{ {s _2}} \\
			{ {\mathbf{v} _2}}
	\end{array}} \right] = \left[ {\begin{array}{*{20}{c}}
			{ - \mathbf{v} _1^T{\mathbf{v} _2} + {s _1}{s _2}} \\
			{ {s _1}{\mathbf{v} _2} + {s _2}{\mathbf{v} _1} + \mathbf{v} _1^ \wedge {\mathbf{v} _2}}
	\end{array}} \right] = \mathbf{q}_1 \mathbf{q}_2
$$

$$
\mathbf{q}_1 \mathbf{q}_2 = \mathbf{q}_1^{+} \mathbf{q}_2 = \mathbf{q}_2^{\oplus} \mathbf{q}_1.
$$

Then, consider the problem of using a quaternion to rotate a spatial point.
$$
\begin{split}
		\mathbf{p}' &= \mathbf{q} \mathbf{p} \mathbf{q}^{-1} = \mathbf{q}^+ \mathbf{p}^+ \mathbf{q}^{ -1} \\
		&= \mathbf{q}^+ \mathbf{q}^{ {-1}^{\oplus}} \mathbf{p}.
	\end{split}
$$
In summary, the conversion formula from quaternion to rotation vector can be written as:
$$
	\begin{cases}
		\theta = 2\arccos {q_0}\\
		{\left[ { {n_x},{n_y},{n_z}} \right]^T} = { { {\left[ { {q_1},{q_2},{q_3}} \right] }^T}}/{\sin \frac{\theta }{2}}
	\end{cases}
$$
And for converting from other representations to quaternions, we only need to reversely follow the above steps.